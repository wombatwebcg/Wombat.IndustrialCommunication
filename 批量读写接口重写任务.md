# 上下文
文件名：批量读写接口重写任务.md
创建于：2024-12-19
创建者：AI Assistant
关联协议：RIPER-5 + Multidimensional + Agent Protocol 

# 任务描述
用户已经将IReadWrite接口中的批量读写方法改为新的签名：
- `OperationResult<Dictionary<string,(DataTypeEnums,object)>> BatchRead(Dictionary<string, DataTypeEnums> addresses)`
- `ValueTask<OperationResult<Dictionary<string, (DataTypeEnums, object)>>> BatchReadAsync(Dictionary<string, DataTypeEnums> addresses)`
- `OperationResult BatchWrite(Dictionary<string, (DataTypeEnums,object)> addresses)`
- `ValueTask<OperationResult> BatchWriteAsync(Dictionary<string, (DataTypeEnums, object)> addresses)`

需要将所有重载这些接口方法的类按照新的签名进行重写。

# 项目概述
这是一个工业通信库，包含多种PLC协议实现（S7、Modbus等），所有实现都继承自IReadWrite接口。当前批量读写方法使用Dictionary<string, object>作为参数，需要改为使用Dictionary<string, DataTypeEnums>（读取）和Dictionary<string, (DataTypeEnums, object)>（写入）。

---
*以下部分由 AI 在协议执行过程中维护*
---

# 分析 (由 RESEARCH 模式填充)

## 当前架构分析

**接口变更对比：**
- **原读取方法：** `OperationResult<Dictionary<string, object>> BatchRead(Dictionary<string, object> addresses)`
- **新读取方法：** `OperationResult<Dictionary<string,(DataTypeEnums,object)>> BatchRead(Dictionary<string, DataTypeEnums> addresses)`
- **原异步读取：** `Task<OperationResult<Dictionary<string, object>>> BatchReadAsync(Dictionary<string, object> addresses)`
- **新异步读取：** `ValueTask<OperationResult<Dictionary<string, (DataTypeEnums, object)>>> BatchReadAsync(Dictionary<string, DataTypeEnums> addresses)`
- **原写入方法：** `OperationResult BatchWrite(Dictionary<string, object> addresses)`
- **新写入方法：** `OperationResult BatchWrite(Dictionary<string, (DataTypeEnums,object)> addresses)`
- **原异步写入：** `Task<OperationResult> BatchWriteAsync(Dictionary<string, object> addresses)`
- **新异步写入：** `ValueTask<OperationResult> BatchWriteAsync(Dictionary<string, (DataTypeEnums, object)> addresses)`

## 需要修改的文件列表

### 1. 基类文件
- `Wombat.IndustrialCommunication/ServerBase/DeviceServer.cs`
  - 第15行：`BatchRead(Dictionary<string, object> addresses)`
  - 第20行：`BatchReadAsync(Dictionary<string, object> addresses)`
  - 第818行：`BatchWrite(Dictionary<string, object> addresses)`
  - 第824行：`BatchWriteAsync(Dictionary<string, object> addresses)`

- `Wombat.IndustrialCommunication/DeviceDataReaderWriterBase.cs`
  - 第46行：`BatchRead(Dictionary<string, object> addresses)`
  - 第183行：`BatchReadAsync(Dictionary<string, object> addresses)`
  - 第729行：`BatchWrite(Dictionary<string, object> addresses)`
  - 第848行：`BatchWriteAsync(Dictionary<string, object> addresses)`

### 2. PLC实现文件
- `Wombat.IndustrialCommunication/PLC/S7/S7TcpServer.cs`
  - 第517行：`BatchRead(Dictionary<string, object> addresses)`
  - 第661行：`BatchReadAsync(Dictionary<string, object> addresses)`
  - 第805行：`BatchWrite(Dictionary<string, object> addresses)`
  - 第949行：`BatchWriteAsync(Dictionary<string, object> addresses)`

- `Wombat.IndustrialCommunication/PLC/S7/S7Communication.cs`
  - 第1119行：`BatchReadAsync(Dictionary<string, object> addresses)`
  - 第1201行：`BatchWriteAsync(Dictionary<string, object> addresses)`

- `Wombat.IndustrialCommunication/Modbus/ModbusRtuServer.cs`
  - 第195行：`BatchRead(Dictionary<string, object> addresses)`
  - 第387行：`BatchReadAsync(Dictionary<string, object> addresses)`
  - 第578行：`BatchWrite(Dictionary<string, object> addresses)`
  - 第773行：`BatchWriteAsync(Dictionary<string, object> addresses)`

- `Wombat.IndustrialCommunication/Modbus/ModbusTcpServer.cs`
  - 第183行：`BatchRead(Dictionary<string, object> addresses)`
  - 第375行：`BatchReadAsync(Dictionary<string, object> addresses)`
  - 第567行：`BatchWrite(Dictionary<string, object> addresses)`
  - 第759行：`BatchWriteAsync(Dictionary<string, object> addresses)`

### 3. 扩展方法文件
- `Wombat.IndustrialCommunication/Common/IDeviceClientExtensions.cs`
  - 第152行：`ExecuteBatchReadAsync` 方法
  - 第216行：`ExecuteBatchReadAsync` 重载
  - 第230行：`ExecuteBatchWriteAsync` 方法
  - 第270行：`ExecuteBatchWriteAsync` 重载

## 技术约束和注意事项

1. **返回类型变更：** 异步方法从 `Task` 改为 `ValueTask`，需要相应调整
2. **参数类型变更：** 读取方法参数从 `Dictionary<string, object>` 改为 `Dictionary<string, DataTypeEnums>`
3. **返回值变更：** 读取方法返回值从 `Dictionary<string, object>` 改为 `Dictionary<string, (DataTypeEnums, object)>`
4. **写入参数变更：** 写入方法参数从 `Dictionary<string, object>` 改为 `Dictionary<string, (DataTypeEnums, object)>`
5. **现有实现：** 大部分实现都返回 `NotImplementedException` 或 `CreateNotSupportedResult()`，需要保持这种模式
6. **扩展方法：** 需要更新扩展方法以匹配新的接口签名 

# 提议的解决方案 (由 INNOVATE 模式填充)

## 方案评估

### 方案1：直接替换法（推荐）
**优点：**
- 简单直接，修改量最小
- 保持接口一致性
- 减少维护负担
- 符合用户明确要求

**缺点：**
- 需要同时更新所有调用方
- 可能破坏现有代码

### 方案2：重载保留法
**优点：**
- 向后兼容
- 不会破坏现有代码

**缺点：**
- 增加接口复杂度
- 需要维护两套方法
- 不符合用户要求

### 方案3：渐进式迁移法
**优点：**
- 平滑迁移
- 给用户时间适应

**缺点：**
- 需要多个版本周期
- 不符合当前任务要求

### 方案4：适配器模式法
**优点：**
- 解耦新旧接口
- 便于测试

**缺点：**
- 增加架构复杂度
- 过度设计

## 最终推荐方案：直接替换法

**实施策略：**
1. **按依赖关系顺序修改：** 基类 -> 实现类 -> 扩展方法
2. **保持现有实现逻辑：** 维持 NotImplementedException 和 CreateNotSupportedResult() 模式
3. **确保返回类型正确：** 异步方法使用 ValueTask 而不是 Task
4. **统一签名格式：** 所有实现使用相同的参数和返回类型

**修改优先级：**
1. 高优先级：基类文件（DeviceServer.cs, DeviceDataReaderWriterBase.cs）
2. 中优先级：PLC实现文件（S7, Modbus相关）
3. 低优先级：扩展方法文件（IDeviceClientExtensions.cs）

**风险控制：**
- 每个文件修改后立即验证编译
- 保持现有异常处理逻辑
- 确保方法可见性不变 

# 实施计划 (由 PLAN 模式生成)

## 修改规范

### 方法签名变更规则
1. **BatchRead方法：**
   - 参数：`Dictionary<string, object>` → `Dictionary<string, DataTypeEnums>`
   - 返回：`OperationResult<Dictionary<string, object>>` → `OperationResult<Dictionary<string,(DataTypeEnums,object)>>`

2. **BatchReadAsync方法：**
   - 参数：`Dictionary<string, object>` → `Dictionary<string, DataTypeEnums>`
   - 返回：`Task<OperationResult<Dictionary<string, object>>>` → `ValueTask<OperationResult<Dictionary<string, (DataTypeEnums, object)>>>`

3. **BatchWrite方法：**
   - 参数：`Dictionary<string, object>` → `Dictionary<string, (DataTypeEnums,object)>`
   - 返回：`OperationResult` (保持不变)

4. **BatchWriteAsync方法：**
   - 参数：`Dictionary<string, object>` → `Dictionary<string, (DataTypeEnums, object)>`
   - 返回：`Task<OperationResult>` → `ValueTask<OperationResult>`

## 实施检查清单

1. 修改 DeviceServer.cs 中的 BatchRead 方法签名（第15行）
2. 修改 DeviceServer.cs 中的 BatchReadAsync 方法签名和返回类型（第20行）
3. 修改 DeviceServer.cs 中的 BatchWrite 方法签名（第818行）
4. 修改 DeviceServer.cs 中的 BatchWriteAsync 方法签名和返回类型（第824行）
5. 修改 DeviceDataReaderWriterBase.cs 中的 BatchRead 方法签名（第46行）
6. 修改 DeviceDataReaderWriterBase.cs 中的 BatchReadAsync 方法签名和返回类型（第183行）
7. 修改 DeviceDataReaderWriterBase.cs 中的 BatchWrite 方法签名（第729行）
8. 修改 DeviceDataReaderWriterBase.cs 中的 BatchWriteAsync 方法签名和返回类型（第848行）
9. 修改 S7TcpServer.cs 中的 BatchRead 方法签名（第517行）
10. 修改 S7TcpServer.cs 中的 BatchReadAsync 方法签名和返回类型（第661行）
11. 修改 S7TcpServer.cs 中的 BatchWrite 方法签名（第805行）
12. 修改 S7TcpServer.cs 中的 BatchWriteAsync 方法签名和返回类型（第949行）
13. 修改 S7Communication.cs 中的 BatchReadAsync 方法签名和返回类型（第1119行）
14. 修改 S7Communication.cs 中的 BatchWriteAsync 方法签名和返回类型（第1201行）
15. 修改 ModbusRtuServer.cs 中的 BatchRead 方法签名（第195行）
16. 修改 ModbusRtuServer.cs 中的 BatchReadAsync 方法签名和返回类型（第387行）
17. 修改 ModbusRtuServer.cs 中的 BatchWrite 方法签名（第578行）
18. 修改 ModbusRtuServer.cs 中的 BatchWriteAsync 方法签名和返回类型（第773行）
19. 修改 ModbusTcpServer.cs 中的 BatchRead 方法签名（第183行）
20. 修改 ModbusTcpServer.cs 中的 BatchReadAsync 方法签名和返回类型（第375行）
21. 修改 ModbusTcpServer.cs 中的 BatchWrite 方法签名（第567行）
22. 修改 ModbusTcpServer.cs 中的 BatchWriteAsync 方法签名和返回类型（第759行）
23. 修改 IDeviceClientExtensions.cs 中的 ExecuteBatchReadAsync 方法签名（第152行）
24. 修改 IDeviceClientExtensions.cs 中的 ExecuteBatchReadAsync 重载方法签名（第216行）
25. 修改 IDeviceClientExtensions.cs 中的 ExecuteBatchWriteAsync 方法签名（第230行）
26. 修改 IDeviceClientExtensions.cs 中的 ExecuteBatchWriteAsync 重载方法签名（第270行）
27. 验证所有文件编译成功
28. 验证接口一致性
29. 验证异常处理逻辑正确 

# 当前执行步骤 (由 EXECUTE 模式在开始执行某步骤时更新)
> 正在执行: "步骤15-18: 修改ModbusRtuServer.cs中的批量读写方法"

# 任务进度 (由 EXECUTE 模式在每步完成后追加)
*   2024-12-19
    *   步骤：1-4. 修改DeviceServer.cs中的批量读写方法签名
    *   修改：DeviceServer.cs - 第15行、第20行、第818行、第824行
    *   更改摘要：将BatchRead、BatchReadAsync、BatchWrite、BatchWriteAsync方法的参数和返回类型更新为新的接口签名
    *   原因：执行计划步骤 1-4
    *   阻碍：无
    *   状态：成功
*   2024-12-19
    *   步骤：5-8. 修改DeviceDataReaderWriterBase.cs中的批量读写方法签名
    *   修改：DeviceDataReaderWriterBase.cs - 第47行、第184行、第729行、第849行
    *   更改摘要：将BatchRead、BatchReadAsync、BatchWrite、BatchWriteAsync方法的参数和返回类型更新为新的接口签名
    *   原因：执行计划步骤 5-8
    *   阻碍：无
    *   状态：成功
*   2024-12-19
    *   步骤：9-12. 修改S7TcpServer.cs中的批量读写方法签名
    *   修改：S7TcpServer.cs - 第517行、第661行、第805行、第949行
    *   更改摘要：将BatchRead、BatchReadAsync、BatchWrite、BatchWriteAsync方法的参数和返回类型更新为新的接口签名
    *   原因：执行计划步骤 9-12
    *   阻碍：无
    *   状态：成功
*   2024-12-19
    *   步骤：13-14. 修改S7Communication.cs中的批量读写方法签名
    *   修改：S7Communication.cs - 第1119行、第1202行
    *   更改摘要：将BatchReadAsync、BatchWriteAsync方法的参数和返回类型更新为新的接口签名，暂时返回重构中提示
    *   原因：执行计划步骤 13-14
    *   阻碍：无
    *   状态：成功
*   2024-12-19
    *   步骤：15-18. 修改ModbusRtuServer.cs中的批量读写方法签名
    *   修改：ModbusRtuServer.cs - 第195行、第387行、第578行、第773行
    *   更改摘要：将BatchRead、BatchReadAsync、BatchWrite、BatchWriteAsync方法的参数和返回类型更新为新的接口签名
    *   原因：执行计划步骤 15-18
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 15:30]
    *   步骤：修复S7Communication.cs中V区地址解析问题
    *   修改：更新ParseVAddress方法支持VW700、VD700等复合地址格式，更新ExtractValueFromBytes和ConvertValueToBytes方法支持V区数据类型，更新ConstructWriteAddress方法支持非Smart200的V区地址构造
    *   更改摘要：修复V区地址解析异常，现在能够正确解析VW700等复合地址格式
    *   原因：用户反馈VW700地址解析失败，需要支持VW、VD、VB等复合地址格式
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 15:35]
    *   步骤：检查清单项目23-26 - 修改IDeviceClientExtensions.cs中的批量读写方法签名
    *   修改：Wombat.IndustrialCommunication/Common/IDeviceClientExtensions.cs
        - 修改ExecuteBatchReadAsync方法签名：Task<OperationResult<Dictionary<string, (DataTypeEnums, object)>>> ExecuteBatchReadAsync(...)
        - 修改ExecuteBatchWriteAsync方法签名：Task<OperationResult> ExecuteBatchWriteAsync(...)
        - 更新方法参数类型以匹配新的接口签名
    *   更改摘要：统一IDeviceClientExtensions.cs中的批量读写扩展方法签名格式
    *   原因：执行计划步骤 23-26
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 15:40]
    *   步骤：检查清单项目27-30 - 验证所有相关文件修改完成
    *   修改：验证所有批量读写方法签名修改
        - 确认所有接口和实现类的方法签名已统一
        - 验证异步方法返回ValueTask类型
        - 检查所有相关文件无遗漏
    *   更改摘要：完成所有批量读写方法签名的统一修改
    *   原因：执行计划步骤 27-30
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 15:45]
    *   步骤：修复S7Communication.cs中Q区和I区批量读取问题
    *   修改：更新OptimizeAddressBlocks方法添加位地址特殊优化逻辑，更新ExecuteBatchRead和ExtractDataFromBlocks方法添加Q区支持，新增OptimizeBitAddresses和OptimizeNonBitAddresses方法
    *   更改摘要：修复Q区和I区批量读取失败问题，现在能够正确处理Q0.1、Q1.0、Q1.2等位地址的批量读取
    *   原因：用户反馈Q区批量读取失败，需要支持位地址按字节边界优化的批量读取逻辑
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 15:50]
    *   步骤：检查清单项目31-34 - 修改测试文件中的批量读写方法调用
    *   修改：Wombat.IndustrialCommunicationTestProject/PLCTests/S7_Smart200.cs, S7_1200.cs
        - 修改批量读取方法调用：使用新的Dictionary<string, DataTypeEnums>格式
        - 修改批量写入方法调用：使用新的Dictionary<string, (DataTypeEnums, object)>格式
        *   更改摘要：更新测试文件以适配新的批量读写方法签名
    *   原因：执行计划步骤 31-34
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 15:55]
    *   步骤：Bug修复 - 修复S7_Smart200.cs中的地址冲突和数据类型推断问题
    *   修改：Wombat.IndustrialCommunicationTestProject/PLCTests/S7_Smart200.cs
        - 修复地址格式错误：使用连续的地址范围避免冲突
        - 修复数据类型推断：根据地址前缀正确推断数据类型（VW->Int16, VD->Int32）
        - 修复地址冲突：为不同测试使用不同的地址范围
        - 修复PrepareSmart200TestData方法中的地址冲突
    *   更改摘要：修复S7_Smart200.cs中的地址格式、数据类型推断和地址冲突问题
    *   原因：用户报告S7_Smart200.cs中存在bug
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 15:55]
    *   步骤：重构S7Communication.cs中的批量读写方法实现
    *   修改：Wombat.IndustrialCommunication/PLC/S7/S7Communication.cs
        - 重构BatchReadAsync方法：实现真正的批量读取功能，包括地址解析、优化、执行和结果提取
        - 重构BatchWriteAsync方法：实现真正的批量写入功能，包括地址解析、值转换、地址构造和写入执行
        - 添加ConvertValueToBytes方法：将各种数据类型转换为字节数组
        - 添加ConstructWriteAddress方法：根据地址信息构造写入地址字符串
        - 利用现有的地址解析、优化和执行逻辑
    *   更改摘要：完成S7Communication.cs中批量读写方法的完整重构，从临时占位符实现改为真正的功能实现
    *   原因：用户要求参考之前的逻辑重构BatchReadAsync和BatchWriteAsync方法
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 16:00]
    *   步骤：修复S7Communication.cs中Q区和I区DbNumber问题
    *   修改：更新ExecuteBatchRead和ExtractDataFromBlocks方法，添加对特殊DbNumber值的处理逻辑，正确识别Q区（-2）、I区（-3）、M区（-4）、V区（-1）
    *   更改摘要：修复Q区和I区DbNumber变成-2的问题，现在能够根据特殊DbNumber值正确构造读取地址
    *   原因：用户反馈OptimizeAddressBlocks后Q区和I区的DbNumber变成-2，需要正确处理特殊DbNumber值
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 16:15]
    *   步骤：修复S7Communication.cs中Q区批量写入失败问题
    *   修改：更新S7CommonMethods.ConvertArg方法，添加对Q区、I区、M区位地址格式的正确解析，设置正确的DataType、ReadWriteLength和IsBit属性
    *   更改摘要：修复Q区批量写入失败问题，现在能够正确解析Q2.0等位地址格式
    *   原因：用户反馈Q区批量写入失败，错误信息"Value was either too large or too small for a UInt16"，需要修复地址解析逻辑
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 16:30]
    *   步骤：修复S7WriteRequest.cs中位写入逻辑错误
    *   修改：移除S7WriteRequest中两处错误的位数据判断逻辑，删除对writeData[0] >= 2的错误判断条件
    *   更改摘要：修复Q区位地址写入失败问题，现在能够正确处理布尔值的位写入
    *   原因：用户反馈Q区批量写入失败，错误信息"Value was either too large or too small for a UInt16"，发现S7WriteRequest中错误的位数据判断逻辑
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 16:45]
    *   步骤：修复S7Communication.cs中Smart200 I区和Q区DbNumber问题
    *   修改：更新ParseQAddress和ParseIAddress方法，为Smart200添加特殊处理逻辑，将I区和Q区地址映射到DB1
    *   更改摘要：修复Smart200中I区和Q区DbNumber设置错误问题，现在Smart200的I区和Q区地址都正确映射到DB1
    *   原因：用户反馈Smart200中所有I区和Q区的DbNumber都应该是1，而不是-2和-3
    *   阻碍：无
    *   状态：待确认
*   [2024-12-19 17:00]
    *   步骤：修正S7Communication.cs中I区和Q区DbNumber设置
    *   修改：更新ParseQAddress和ParseIAddress方法，将I区和Q区的DbNumber都设置为0，移除版本判断逻辑
    *   更改摘要：修正I区和Q区DbNumber设置错误，现在无论1200还是Smart200，I区和Q区的DbNumber都正确设置为0
    *   原因：用户纠正，无论1200还是Smart200，读I区和Q区都是不需要DbNumber的，都是默认为0
    *   阻碍：无
    *   状态：待确认 